#!/usr/bin/env python3
"""
Safely clean up custom collections from _system database.

This script backs up any data in custom collections before removing them
from the _system database.
"""

import sys
import os
import json
from datetime import datetime
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from entity_resolution.utils.database import DatabaseManager
from entity_resolution.utils.config import Config

def backup_collection_data(sys_db, col_name, backup_dir="backups"):
    """Backup collection data to JSON file."""
    try:
        if not os.path.exists(backup_dir):
            os.makedirs(backup_dir)
        
        col = sys_db.collection(col_name)
        count = col.count()
        
        if count == 0:
            print(f"  ℹ️  {col_name}: empty, no backup needed")
            return True
        
        print(f"  📋 {col_name}: {count} documents - creating backup...")
        
        # Get all documents
        cursor = col.all()
        documents = list(cursor)
        
        # Save to JSON file
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_file = os.path.join(backup_dir, f"{col_name}_backup_{timestamp}.json")
        
        with open(backup_file, 'w') as f:
            json.dump(documents, f, indent=2, default=str)
        
        print(f"  ✅ Backup saved: {backup_file}")
        return True
        
    except Exception as e:
        print(f"  ❌ Error backing up {col_name}: {e}")
        return False

def main():
    print("🧹 Safely cleaning up _system database...")
    
    config = Config.from_env()
    db_manager = DatabaseManager()
    
    if not db_manager.test_connection():
        print("❌ Could not connect to database")
        return False
    
    # Get system database connection
    sys_db = db_manager.get_database()
    
    # Custom collections that should not be in _system database
    custom_collections = [
        'entities',
        'customers', 
        'entity_clusters',
        'similarities',
        'golden_records',
        'test_collection'
    ]
    
    print(f"🔍 Checking for custom collections in _system database...")
    
    # Check which custom collections exist and backup data
    existing_custom = []
    for col_name in custom_collections:
        if sys_db.has_collection(col_name):
            existing_custom.append(col_name)
            print(f"  ⚠️  Found custom collection: {col_name}")
    
    if not existing_custom:
        print("✅ No custom collections found in _system database")
        return True
    
    print(f"\n📊 Found {len(existing_custom)} custom collections in _system database")
    
    # Backup any data in custom collections
    print(f"\n💾 Backing up data from custom collections...")
    backup_success = True
    for col_name in existing_custom:
        if not backup_collection_data(sys_db, col_name):
            backup_success = False
    
    if not backup_success:
        print("❌ Some backups failed. Aborting cleanup for safety.")
        return False
    
    # Delete custom collections from _system database
    print(f"\n🗑️  Deleting custom collections from _system database...")
    
    deleted_count = 0
    for col_name in existing_custom:
        try:
            if sys_db.has_collection(col_name):
                sys_db.delete_collection(col_name)
                print(f"  ✅ Deleted: {col_name}")
                deleted_count += 1
            else:
                print(f"  ℹ️  Already deleted: {col_name}")
        except Exception as e:
            print(f"  ❌ Error deleting {col_name}: {e}")
    
    print(f"\n🎉 Successfully deleted {deleted_count} custom collections from _system database")
    
    # Verify cleanup
    print(f"\n🔍 Verifying cleanup...")
    remaining_custom = []
    for col_name in custom_collections:
        if sys_db.has_collection(col_name):
            remaining_custom.append(col_name)
    
    if remaining_custom:
        print(f"⚠️  Warning: {len(remaining_custom)} collections still exist:")
        for col in remaining_custom:
            print(f"  - {col}")
    else:
        print("✅ All custom collections successfully removed from _system database")
    
    print(f"\n📁 Data backups saved in 'backups/' directory")
    print("   You can restore this data to a proper application database if needed.")
    
    return True

if __name__ == "__main__":
    try:
        success = main()
        if success:
            print("\n🎉 Database cleanup completed successfully!")
        else:
            print("\n❌ Database cleanup failed!")
            sys.exit(1)
    except KeyboardInterrupt:
        print("\n❌ Operation cancelled by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n❌ Unexpected error: {e}")
        sys.exit(1)
